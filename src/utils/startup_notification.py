"""
Startup Notification System
Отправка уведомлений администраторам при запуске бота
"""

import logging
import telebot
from src.utils.telegram_retry import safe_send_message

logger = logging.getLogger(__name__)

def send_first_launch_notification(bot: telebot.TeleBot, admin_ids: list):
    """
    Send comprehensive first launch notification to admins
    Отправка детального уведомления о первом запуске админам
    """

    message = f"""
🚀 RunBot успешно запущен!

✅ База данных подключена
✅ Все модули загружены
✅ Бот готов к работе

👥 Администраторов: {len(admin_ids)}
🌐 Хост: BotHost.ru

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎉 RunBot v1.3.0 - Первый запуск!

Бот успешно запущен и готов к тестированию!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 НЕОБХОДИМО ПРОТЕСТИРОВАТЬ:

1️⃣ РЕГИСТРАЦИЯ УЧАСТНИКОВ
✅ Регистрация нового участника через /register
✅ Проверка уникальности номера (REGXXX)
✅ Выбор дистанции (взрослый/детский забег)
✅ Валидация данных (ФИО, телефон, дата рождения)

2️⃣ СОБЫТИЯ (🎉)
✅ Просмотр списка событий (фильтры работают?)
✅ Фильтры: 🏃 Забеги, 🏅 Турниры, 📋 Все
✅ Регистрация на событие
✅ Получение стартового номера (BIB)
✅ Просмотр своих событий

3️⃣ ЧЕЛЛЕНДЖИ (🏆)
✅ Просмотр активных челленджей
✅ Фильтры: 💪 Отжимания, 🦵 Приседания, 🧘 Планка, 🏃 Бег, 👣 Шаги, 📋 Все
✅ Участие в челлендже
✅ Отправка отчёта с фото
✅ Просмотр своей статистики

4️⃣ АДМИН-ПАНЕЛЬ (🔐)

Участники (👥):
✅ Просмотр списка участников
✅ Фильтрация по дистанциям
✅ Просмотр участников события
✅ Просмотр участников челленджа

События (🎉):
✅ Создание нового события
✅ Выбор типа (Забег/Турнир)
✅ Список всех событий
✅ Просмотр участников события

Челленджи (🏆):
✅ Создание нового челленджа
✅ Выбор типа (отжимания/приседания/планка/бег/шаги)
✅ Список всех челленджей
✅ Просмотр участников челленджа

Модерация (🔍):
✅ Просмотр ожидающих отчётов
✅ Одобрение отчёта
✅ Отклонение отчёта
✅ Просмотр всех отчётов

Экспорт (📤):
✅ Экспорт участников (все/по событию/по челленджу)
✅ Экспорт событий (конкретное/все)
✅ Экспорт челленджей (конкретный/все)
✅ Экспорт отчётов
✅ Экспорт рейтингов

Статистика (📊):
✅ Общая статистика
✅ Рейтинги участников

Настройки (⚙️):
✅ Состояние бота (uptime, память, CPU)
✅ База данных (статистика)
✅ Кнопка обновления данных

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 ТЕСТОВЫЕ ДАННЫЕ СОЗДАНЫ:

👥 5 участников (взрослые и дети)
🏆 5 челленджей (ВСЕ типы: отжимания, приседания, планка, бег, шаги)
🎉 8 событий (ВСЕ типы: забеги, турниры, челленджи)
   → 3 забега (RUN_EVENT)
   → 3 турнира (TOURNAMENT)
   → 2 челленджа-события (CHALLENGE)
📝 Регистрации на события
📊 Отчёты (одобренные, ожидающие, отклонённые)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 ВАЖНЫЕ ПРОВЕРКИ:

1. Фильтры остаются после применения ✓
2. Кнопки навигации работают корректно
3. Экспорт Excel файлов
4. Модерация отчётов
5. Создание событий и челленджей
6. Получение уникальных номеров

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 ОБРАТНАЯ СВЯЗЬ:

После тестирования, пожалуйста, сообщите:
• Что работает правильно ✅
• Что требует исправления ❌
• Предложения по улучшению 💡

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚀 Приятного тестирования!
"""

    for admin_id in admin_ids:
        try:
            # Send as plain text with emojis (no Markdown formatting)
            safe_send_message(
                bot,
                admin_id,
                message,
                parse_mode=None
            )
            logger.info(f"First launch notification sent to admin {admin_id}")
        except Exception as e:
            logger.error(f"Failed to send notification to admin {admin_id}: {e}")

def send_startup_notification(bot: telebot.TeleBot, admin_ids: list):
    """
    Send regular startup notification to admins
    Отправка обычного уведомления о запуске
    """

    message = """
🤖 *RunBot запущен*

✅ Бот успешно запущен и работает

Используйте /admin для доступа к админ-панели
"""

    for admin_id in admin_ids:
        try:
            safe_send_message(
                bot,
                admin_id,
                message,
                parse_mode='Markdown'
            )
            logger.info(f"Startup notification sent to admin {admin_id}")
        except Exception as e:
            logger.error(f"Failed to send notification to admin {admin_id}: {e}")
